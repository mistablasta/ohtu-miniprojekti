{% extends "layout.html" %}

{% block title %}
Bibliography App
{% endblock %}

{% block body %}

<div class="top-bar">
  <h2>Bibliography App</h2>
</div>

<!-- Search and Filter Section -->
<div class="main-container" style="gap: 16px;">
  {% if not filter %}
  <div class="button-container">
      <form action="/search" method="get">
        <input
          type="text"
          name="query"
          placeholder="Search entries..."
          value="{{ query | default('') }}"
        >
        <button type="submit">Search</button>
      </form>

      <form action="/search" method="get">
        <input type="hidden" name="query" value="{{ query }}">
        <input type="hidden" name="filter" value="1">
        <button type="submit">Show Filters</button>
      </form>
    </div>
    {% endif %}

  {% if filter %}
    <div class="menu-container">
      <h3>Search & Filters</h3>
        {% if error %}
        <div class="alert">
          {{ error }}
        </div>
        {% endif %}
      <form action="/search" method="get">
        <input type="hidden" name="filter" value="1"> 
        
        <p>
          <input
            type="text"
            name="query"
            placeholder="Search entries..."
            value="{{ query | default('') }}"
            style="width: 96%; padding: 8px;"
          >
        </p>

        <!-- 2. Filter Options -->
        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
          
          <div>
            <label for="sort">Sort by:</label>
            <select name="sort">
              <option value="id" {% if sort=="id" %}selected{% endif %}>Default (Newest)</option>
              <option value="title_asc" {% if sort=="title_asc" %}selected{% endif %}>Title (A-Z)</option>
              <option value="title_desc" {% if sort=="title_desc" %}selected{% endif %}>Title (Z-A)</option>
              <option value="year_asc" {% if sort=="year_asc" %}selected{% endif %}>Year (Oldest)</option>
              <option value="year_desc" {% if sort=="year_desc" %}selected{% endif %}>Year (Newest)</option>
            </select>
          </div>

          <div>
            <label>Year:</label>
            <input type="number" name="year_min" placeholder="Min" value="{{ year_min | default('') }}" style="width: 60px;">
            -
            <input type="number" name="year_max" placeholder="Max" value="{{ year_max | default('') }}" style="width: 60px;">
          </div>

          <div>
            <label for="type">Type:</label>
            <select name="entry_type" id="type"> 
              <option value="">All Types</option>
              {% for t in types %}
                <option value="{{ t.name }}" {% if type ==t.name %}selected{% endif %}>{{ t.name.capitalize() }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <p>
          <label>Tags:</label>
          <div class="tags-checkboxes">
            {% for tag in all_tags %}
              <label style="display: inline-block; margin-right: 10px;">
                <input 
                  type="checkbox" 
                  name="tags" 
                  value="{{ tag }}"
                  {% if tag in selected_tags %}checked{% endif %}
                > 
                {{ tag }}
              </label>
            {% endfor %}
          </div>
        </p>

        <button type="submit" style="padding: 8px 16px; background-color: #4CAF50; color: white; border: none; cursor: pointer;">
          Search with Filters
        </button>
      </form>

      <form action="/search" method="get" style="margin-top: 10px;">
        <input type="hidden" name="query" value="{{ query }}">
        <button type="submit" style="background: none; border: none; color: blue; text-decoration: underline; cursor: pointer;">
          Hide Filters
        </button>
      </form>
    </div>
  {% endif %}
  <!-- Actions -->
  <b><a id="error" style="color: black; height: 1rem; margin: 0;"></a></b>
  <div class="main-container-actions">
    <a href="/new_entry" class="button general-button">Add entry</a>
    <a id="batch-delete" class="button general-button">Delete selection</a>
    <a id="batch-bibtex" class="button general-button">Export BibTeX</a>
    <a id="select-all" class="button general-button">Select All</a>
  </div>

  <!-- N채ytt채채채 entryt -->
  <div class="main-entry-container">
    <div class="entries-container">
      {% for entry in entries %}
      <div class="entry-card" data-entry-id="{{ entry.id }}">
        <div class="entry-card-selector">
            <input class="entry-checkbox" type="checkbox">
        </div>
        
        <div style="display: flex; flex-direction: column;;">
          <b>{{ entry.type.name|capitalize }}</b>
          {% for key, value in entry.fields.items() %}
            {% if value and key != 'id' %}
              <div class="entry-content">
                  <strong>{{ key|capitalize }}:</strong> <span title="{{ value }}">{{ value }}</span>
              </div>
            {% endif %}
          {% endfor %}
          
          {% if entry.tags %}
          <div class="entry-content">
            <strong>Tags:</strong> {{ entry.get_tags() }}
          </div>
          {% endif %}

          <!-- Edit and Delete buttons -->
          <div style="margin-top: 10px;">
            <a href="/edit_entry/{{ entry.id }}" style="text-decoration: none;">
              <button type="button">Edit</button>
            </a>
            <form action="/delete_entry/{{ entry.id }}" method="post" style="display: inline;">
              <button type="submit" onclick="return confirm('Are you sure you want to delete this entry?')">Delete</button>
            </form>
          </div>
        </div>
      </div>
      {% else %}
        <h4>No entries found</h4>
      {% endfor %}
    </div>
  </div>
</div>
{% endblock %}

{% block extra %}

    <!-- Handle batch actions-->
    <script>
        const batchUrl = {{ url_for("batch_action") | tojson }};
        const errorBox = document.querySelector("#error");
        const batchDelete = document.querySelector("#batch-delete");
        const batchBibtex = document.querySelector("#batch-bibtex");
        const checkboxes = document.querySelectorAll(".entry-checkbox");
        const selectAll = document.querySelector("#select-all")

        const showError = msg => (errorBox.textContent = msg || "");

        const downloadContent = content => {
            const a = document.createElement("a");
            a.href = "data:text/plain," + encodeURIComponent(content);
            a.download = "references.bib";
            a.click();
        };

        const getSelectedEntries = () =>
            [...checkboxes]
                .filter(c => c.checked)
                .map(c => c.closest(".entry-card")?.dataset.entryId)
                .filter(Boolean);

        async function runBatchAction(action) {
            // Clear any previous errors
            showError("");

            // Ensure selection is made
            const selection = getSelectedEntries();
            if (!selection.length) {
                showError("Make a selection first!");
                return;
            }

            // Confirm action if deleting
            if (action === "delete")
                if (!confirm(`Are you sure you want to delete ${selection.length} entries?`))
                    return

            try {
                const response = await fetch(batchUrl, {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({ action, selection })
                });

                const data = await response.json();

                if (!response.ok) {
                    showError(data.error || "An error occurred");
                    return;
                }

                // Handle deletion
                if (action === "delete") {
                    window.location.reload()
                    return
                }

                // Handle bibtex response
                if (action === "bibtex" && data.bibtex) {
                    downloadContent(data.bibtex);
                }

            } catch (err) {
                showError("Network error" + err.toString());
            }
        }

        let allSelected = false;

        batchDelete.addEventListener("click", (event) => runBatchAction("delete"))
        batchBibtex.addEventListener("click", (event) => runBatchAction("bibtex"))
        selectAll.addEventListener("click", (event) => {
            allSelected = !allSelected;
            checkboxes.forEach((checkbox) => checkbox.checked = allSelected)
        })
    </script>
{% endblock %}